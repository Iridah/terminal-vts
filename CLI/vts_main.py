# vts_main
import os
import sys
import time
import shutil
from datetime import datetime

# IMPORTACIONES PROPIAS
from vts_utils import limpiar_pantalla, pausar, imprimir_separador
from vts_logic import *
from vts_graphics import visualizar_analitica_macro
from database_manager import (
    verificar_conexion, 
    inicializar_db,
    obtener_conexion
)

DB_NAME = "vts_mardum.db"

def pantalla_inicio():
    os.system('cls' if os.name == 'nt' else 'clear')
    if os.name == 'nt':
        os.system('color 0A')
    
    # El Arte de Illidan Wide
    illidan_wide = r"""
....................................................................................................
............................................:--:....................................................
..........................................-#%@@%*##%*+:..................................:...:......
.........................................:-:..::+%%########+-..................::::--+**#%%%%#**++-.
..........................::-:....................=%@%######*+=:.........:-=#%%%#%%%%%##%%%%%%%%%%%%
..................:=*=...+#:.:.=%@%#+-:............:#%%@@##%##**+=:.:-+#%%%%%%%%%%%%%%%%%%%%%%%%%%%#
.................=%-...:+@:...*@@@@@@%-.............-%@@@@@%%@%#**+*#%%%%%%%%%%%%%%%%%%%%%%%%#*++++=
................-%-....:##....:#%=#%@@**:............+%@@@@@@%@@@%#*++#%%%%%%%%%%%%%%%%##+:.........
................-#-....:##:.=@@@@%%%**@%#-............%@@@@@@@@@@@@@#+++*%%%####%%%%%%%+............
................:##=:..:*##%@#*@@@@***.+-%*-:.....:=%#%@@@@@@@@@@@@@@@#+++#%%%%%##%#%%%%+::.........
..................+%%##%%%***%@@@%%%@@%*#=+*##*-:*#@%#%%@@@@@@@@@@@@@@@%*+++*#%%%%*#*%#%%%%#+:......
..................::-+++=-..-#%*##@%@@%%%#==--:::#:...#%@@@@@@@@@@@@@@@@@#=#*+*%*:....::-+**+*#*-:.:
.............................:%#@%@#*@@%%@@@%:.::-...+@@@@@@@@%@%@@@@@@@@@##@@*+=.................++
.............................-=:-==+=*@*=+#*+::==:.:*@@@@@@@@%%%%@@@@@@@@@@%%@%@+:..................
..........................:.=*=++*+=+*+=*%%#%=...-*%@@@@@@@%%%%%@%%%@@@@@@@@%@@%@%=:................
...:.-:.................:=++=%%##**##%%#*=*%%###%%%@@@%%%%%%%%%%%%@%%%%%@@@@@@@@@%%*:...............
....=:...................:-:@##*#*#%%%%%%%%##%%###%@@%%%%%%%%%%%%%%%%%%%@@@@@@@@@%%@%-..............
...:=...................:..+@**+=+#%@%%@@@@@@%#*#%@@%%%%%%%%%%%%%%%%#.=@%%%%%%%%%%%%%@+.............
...:-:.......:.............+#%#####@%#@@@@@@@@@%#@@@%%%%%%%%%%%%%%%#-...-#%%%%%%%%%%%%%#:...........
...--:.......::............:%@@**%%%#%%%%%@@@@@@%%%%%%%%%%#%*::.=%%#:.....-%%%%%=#%%%%%%*:..........
...--:.......::.............*@@%%%@%##%%%%@%@@@%@%%%%%%%%%%*:.....-#-......-%%%@:.:+%%%%%+..........
...--::......:::..........=#@%%%#@%%####--@@%%%%%%%%%#-.:*%:.......:-........#%%*:..:%%%%%+.........
...-=-::......::::.:....:*%#=#**%@%%##*+:-@%%%*#*#%%%*....-.........:........:#%%*...-#@%%%=........
...-==::-:.::=:::::....:#%##*=*%@@%%##%#+%%%%%*::=#%%#:.......................-%%@:...:#@@%#........
....-=+-::-=++:.::::::=@%#*+=#@@@@@@@@%@@@%##%=...=%%#-...................::...=#%#....:+%@@=.......
....:-+**+=++*=..:::-+%%#%*#@@@@%##@@@@%%%%*#*.....=%%-.:.............:..:+.....:#%=:....=@@@:......
....:-==+**####*+*#==+%##+*%@@@@@@@@@@@%%#%%#:......=%#=.............::.:+:......:%*:.....+@@*......
.........=##%@#%%#*##*#%***%@@@@@@#@@@@@%%%@%*.......=%*:...........:-:=*-.......::%:.....:*@@-.....
.........:*#%%%%%######++*#%@@@@#+=@@@@@@@%%%%###*+*#*#+........:..:-=+*-..........-*.......-@#.....
............+%##@%@%%#%%%*=+++*+=:+@@@@@@@@@@%%%%###+=+*++**++++*+:-*#+:............-:.......=@=....
...........::::-#@%%@@@@%%###*=--*@@@@@@@%@@%%%%%%%%%%#*+++++=+=::=*+:.:......................-%:...
..................+%@%%%%@%%*=====%%%@@@%%%%##*=+######****+=::===-............................=+...
.................::+..:##%%%%+===-::-#@@@%%%##****+--==-::::-*=:................................*:..
.......................+**####*======----=====------==---=++=:..................................:#..
..........................-**####*+===---::::::::---=+***+-......................................::.
    """
    print(illidan_wide)
    print("\n" + " " * 30 + "INICIALIZANDO MOTOR DEL MARTILLO VIL")
    print("-" * 100)
    time.sleep(3)

def menu():
    # 1. ARRANQUE
    pantalla_inicio()
    inicializar_db()
    conectado = verificar_conexion()
    
    if conectado:
        verificar_integridad_base() 
        print(f"‚úÖ MOTOR SQL CONECTADO | {datetime.now().strftime('%H:%M')}")
        time.sleep(1)

    # 2. BUCLE PRINCIPAL
    while True:
        limpiar_pantalla()
        
        # Alerta de stock cr√≠tico (unificado a stock_actual)
        alerta = ""
        try:
            with obtener_conexion() as conn:
                criticos = conn.execute("SELECT COUNT(*) FROM inventario WHERE stock_actual <= 1").fetchone()[0]
                if criticos > 0: alerta = f" ‚ö†Ô∏è {criticos} CR√çTICOS"
        except: pass
        
        print(f"        üêÆ VTS v2.1.0 üêÆ | STATUS: {'ONLINE' if conectado else 'OFFLINE'}{alerta}")
        imprimir_separador()
        print(" [1] üì¶ REGISTRAR MOVIMIENTO (Entrada/Egreso)")
        print(" [2] üîç B√öSQUEDA R√ÅPIDA")
        print(" [3] üì¶ CALCULADORA DE PACKS")
        print("-" * 50)
        print(" [4] üí∞ TABLERO ESTRAT√âGICO / VALORIZACI√ìN")
        print(" [5] üõí SUGERENCIA DE REPOSICI√ìN")
        print(" [6] üõ†  ADMINISTRACI√ìN")
        print(" [7] üìä ANALYTICS VISUAL")
        print("-" * 50)
        print(" [0] üö™ GUARDAR Y SALIR")
        
        op = input("\nVTS_INPUT > ") 

        if op == "0":
            print("\nüíæ Ejecutando respaldo de seguridad...")
            ejecutar_backup(forzar=True)
            print("üëã Saliendo del sistema VTS. ¬°Buen turno!")
            break

        if not conectado:
            print("‚ö†Ô∏è MODO OFFLINE: Solo opci√≥n (0)"); pausar(); continue

        # MAPEADO CORREGIDO A vts_logic SANEADO
        if op == "1": registrar_movimiento_mercaderia()
        elif op == "2": busqueda_rapida()
        elif op == "3": calculadora_packs()
        elif op == "4": tablero_estrategico()
        elif op == "5": generar_lista_compras()
        elif op == "6": modulo_administracion()
        elif op == "7": visualizar_analitica_macro()
        else:
            print("‚ùå Opci√≥n no v√°lida."); time.sleep(1)    

if __name__ == "__main__":
    menu()